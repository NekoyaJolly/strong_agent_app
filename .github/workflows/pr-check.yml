name: PR Quality Check

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [ main, develop ]

env:
  NODE_VERSION: '22'

jobs:
  # =====================================
  # PRå“è³ªãƒã‚§ãƒƒã‚¯
  # =====================================
  pr-quality:
    name: ðŸ” PR Quality Check
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¥ Install dependencies
        run: npm ci --ignore-scripts

      - name: ðŸ” Run ESLint with annotations
        run: |
          npm run lint > lint-results.txt 2>&1 || true
          if [ -s lint-results.txt ]; then
            echo "âš ï¸ ESLint found issues:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat lint-results.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… ESLint passed with no issues" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸ” Type check
        run: npm run type-check

      - name: ðŸ§ª Run tests
        run: npm run test:run

      - name: ðŸ—ï¸ Build check
        run: npm run build

      - name: ðŸ“Š Test coverage diff
        run: |
          npm run test:coverage
          echo "ðŸ“Š Test coverage report generated" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“‹ PR Summary
        run: |
          echo "## ðŸ“‹ PR Quality Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ESLint: Passed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… TypeScript: Passed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Tests: Passed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Build: Passed" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“Š Coverage: Available in artifacts" >> $GITHUB_STEP_SUMMARY

  # =====================================
  # å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«åˆ†æž
  # =====================================
  pr-analysis:
    name: ðŸ“Š Change Analysis
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“Š Analyze changed files
        run: |
          echo "## ðŸ“Š Changed Files Analysis" >> $GITHUB_STEP_SUMMARY
          echo "### Modified Files:" >> $GITHUB_STEP_SUMMARY
          git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | while read file; do
            echo "- ðŸ“„ \`$file\`" >> $GITHUB_STEP_SUMMARY
          done
          
          echo "### File Statistics:" >> $GITHUB_STEP_SUMMARY
          git diff --stat ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“Š Code complexity check
        run: |
          echo "### ðŸ“Š Code Complexity:" >> $GITHUB_STEP_SUMMARY
          find src -name "*.ts" -type f | head -10 | while read file; do
            lines=$(wc -l < "$file")
            echo "- \`$file\`: $lines lines" >> $GITHUB_STEP_SUMMARY
          done
